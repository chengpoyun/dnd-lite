# D&D Lite 專案 - AI 助理工作指南

## 📝 核心工作原則

### 1. 🔄 修改前討論 (原則)
- **重大修改前必須先說明計劃**
- 詳細解釋：修改內容、原因、預期效果
- **等待用戶確認「可以」後才開始執行**

**🎯 可直接執行的簡單修改**：
- 修正拼字錯誤、語法錯誤
- 調整文字內容、註解更新
- 簡單的樣式調整（顏色、間距等）
- 文檔內容更新
- 不涉及架構或邏輯的修改

**⚠️ 必須討論的重大修改**：
- 新增或修改功能邏輯
- 資料庫結構變更
- API 介面調整
- 組件架構修改
- 安全性相關變更

### 2. ✅ 修改後驗證 (自動執行)
- 修改完成後立即檢查結果是否符合討論內容
- 發現偏差時主動修正，以討論結果為準
- 確保最終結果與約定內容完全一致

### 3. 📊 專案狀態透明化
- 每次修改後更新專案狀態
- 記錄已知問題和解決進度
- 保持工作流程可追蹤

### 4. 🧪 單元測試工作原則 (必須遵守)
**🎯 確保代碼品質和防止回歸問題**

**必須執行的測試檢查：**
- **所有修改都需確認單元測試沒有問題** - 每次代碼變更後都要執行 `npm test` 確保現有測試通過
- **每次成功修復一個問題，都要考慮是否新增相關的單元測試** - 為修復的 bug 建立測試案例防止再次發生
- **每次實作完畢一個新功能，都要考慮是否新增相關的單元測試** - 為新功能建立完整測試覆蓋率

**測試最佳實務：**
- ✅ 在修改核心邏輯前先運行測試確保起始狀態正常
- ✅ 使用測試保護腳本 `./test-protection.sh` 驗證測試能捕獲破壞性修改
- ✅ 針對資料保存、用戶互動、錯誤處理建立測試案例
- ✅ 遵循測試文檔 `src/test/TEST-README.md` 的指引

### 5. 🔄 資料持久化檢查清單 (防止回歸問題)
**🎯 每次修改涉及狀態更新時必須檢查**

**必須確認的事項：**
- **本地狀態更新後，是否需要保存到數據庫？** - 任何 `setState` 或狀態修改都要檢查是否需要對應的保存操作
- **用戶操作完成後，資料是否會持久化？** - 特別注意上傳、編輯、新增等操作
- **頁面重載後，修改的資料是否還存在？** - 這是最重要的驗證點

**高風險操作清單：**
- 🔴 **圖片/檔案上傳** - 必須有對應的 URL 保存函數
- 🔴 **表單輸入** - 確認有 onSave 回調和數據庫更新
- 🔴 **拖放排序** - 順序改變需要立即保存
- 🔴 **開關切換** - 布林值變更要觸發保存
- 🔴 **新增/刪除項目** - 列表變更必須同步到數據庫

**開發自我檢查流程：**
1. **修改前** - 確認現有保存機制
2. **修改中** - 每個狀態更新都配對一個保存操作  
3. **修改後** - 測試重載後資料是否持續存在
4. **測試保護** - 為新功能添加對應測試案例

### 6. 🎯 獨立保存函數設計原則 (必須遵守)
**🎯 每個可修改的數值都應該有專屬的保存函數**

**設計原則：**
- **單一職責** - 每個保存函數只負責一個特定數值或相關數值組
- **精確更新** - 只更新被修改的特定值，避免不必要的數據庫操作
- **獨立性** - 各值的修改和保存互不影響，失敗不會連帶其他值
- **清晰命名** - 函數名稱明確指出保存的內容 (如 `saveHP`, `saveAC`, `saveInitiative`)

**實施模式：**
```typescript
// ✅ 推薦：獨立保存函數
const saveHP = async (current: number, max: number) => Promise<boolean>
const saveAC = async (ac: number) => Promise<boolean>  
const saveInitiative = async (initiative: number) => Promise<boolean>

// ❌ 避免：大型綜合保存函數
const saveAllStats = async (stats: CharacterStats) => Promise<boolean>
```

**優勢說明：**
- **性能優化** - 只傳輸和更新必要的數據
- **錯誤定位** - 可以精確知道哪個值保存失敗
- **用戶體驗** - 部分保存失敗不影響其他已成功保存的值
- **維護性** - 修改特定值的保存邏輯不影響其他值

## 專案特定規則

### 代碼風格
- 使用 TypeScript 嚴格模式
- React 組件使用函數式寫法
- 優先使用 async/await 而非 Promise.then()

### 資料庫操作
- 永遠使用 Database，避免 localStorage
- 所有資料操作都要有錯誤處理
- 使用 Supabase 的 RLS 政策確保安全性
- **🔑 狀態持久化黃金原則：每個用戶操作的狀態變更都必須有對應的數據庫保存機制**

### 🛢️ 資料庫遷移安全原則 (必須遵守)
**🚨 所有 DB Migration 都必須確保原有資料不會損毀**

**必須執行的安全檢查：**
1. **備份驗證** - 確認重要資料已備份或可恢復
2. **向下兼容** - 新結構必須支援現有資料格式
3. **資料保護** - 使用 `ALTER` 添加欄位，避免 `DROP` 刪除欄位
4. **測試驗證** - Migration 後確認現有功能正常運作
5. **回滾準備** - 準備反向操作以防需要回退

**禁止的危險操作：**
- ❌ `DROP TABLE` - 刪除表格
- ❌ `DROP COLUMN` - 刪除欄位 (除非確認無資料)
- ❌ `ALTER COLUMN ... DROP` - 刪除約束或預設值
- ❌ 沒有備份的批量 `UPDATE` 或 `DELETE`

**推薦的安全做法：**
- ✅ `ALTER TABLE ... ADD COLUMN` - 添加新欄位
- ✅ `CREATE INDEX IF NOT EXISTS` - 安全創建索引
- ✅ 使用 `COALESCE` 處理 NULL 值
- ✅ 分階段遷移：先添加，後遷移資料，最後清理

### Migration 標準流程 (遠端 Supabase)
1. **安全性評估** → 檢查 Migration 是否會損毀資料
2. **建立 migration 文件** → 創建新的 `.sql` 檔案
3. **執行 migration** → ⚠️ **透過 Supabase CLI 推送到遠端**
4. **驗證更新** → 確認遠端資料庫欄位實際更新成功
5. **資料完整性檢查** → 確保現有資料完好無損
6. **測試功能** → 確保應用程式正常運作

### UUID 驗證最佳實務
**🔑 核心原則：防範無效資料進入資料庫**

**必須執行的驗證檢查：**
1. **多層級驗證** - 在服務函數和資料管理器中都要實作 UUID 驗證
2. **空值檢查** - 絕不允許空字串或 null 值傳遞到資料庫操作
3. **格式驗證** - 確認 UUID 符合正確格式（36 字元含連字號）
4. **防禦性程式設計** - 在關鍵資料流程點加入檢查機制

### 開發流程
- 修改資料庫結構時，創建 migration 檔案
- 重大變更前先備份相關檔案
- 使用 `multi_replace_string_in_file` 進行批量修改

### 用戶體驗
- 提供載入狀態和錯誤訊息
- 確保認證和匿名用戶都能正常使用
- 保持 UI 響應式設計
- **🎯 手機優先 (Mobile-First)** - 主要目標為手機瀏覽器使用
- **📱 響應式設計 (RWD)** - 確保各種裝置都能良好顯示
- **觸控友善** - 按鈕大小適合手指操作

### 檔案組織
- Services 放在 `services/` 目錄
- 組件放在 `components/` 目錄  
- 類型定義統一在 `lib/supabase.ts`
- Migration 檔案使用時間戳命名

## 🎲 D&D 5E 規則合規性

### 必須遵守的原則
- **所有功能必須符合 D&D 5E 官方規則**
- 遊戲機制、數值計算、術語使用都要準確
- 參考來源：[D&D 5e Tools](https://5e.tools/)

### 實作指導
- 用戶需求不明確時，直接採用 D&D 標準規則
- 發現不符合規則的修改時，必須告知用戶
- 優先考慮遊戲平衡性和規則正確性

## 🔧 技術棧規範

### 前端技術
- **React + TypeScript** - 主要開發框架
- **Tailwind CSS** - 樣式系統
- **Vite** - 建置工具

### 開發環境設定
- **開發伺服器** - 永遠使用 `localhost:3000` 執行 `npm run dev`
- **端口固定** - 確保開發環境一致性，避免端口衝突問題

### 後端與資料庫
- **Supabase** - 後端即服務 (遠端)
- **PostgreSQL** - 資料庫
- **Row Level Security (RLS)** - 資料安全

## 特殊注意事項

- 這是一個 D&D 角色管理應用
- 支援多角色管理
- 需要處理戰鬥、技能、物品等遊戲元素
- 考慮手機和桌面使用體驗

## 🔄 每日開發流程
- [ ] 確認專案狀態和已知問題
- [ ] 與用戶討論修改計劃
- [ ] 獲得確認後執行修改
- [ ] **持久化檢查** - 驗證所有狀態更新都有對應的保存機制
- [ ] **重載測試** - 確認頁面重載後用戶資料完整
- [ ] 測試修改結果
- [ ] 更新專案狀態

## 更新記錄

- 2026-01-27: 移除 localStorage，改用完整 database 架構
- 2026-01-27: 添加 user_settings 表和物品管理系統
- 2026-01-27: 整合原 .assistant-notes.md 內容，加強工作流程規範