# 角色數值更新與保存測試

## 概述

此測試套件確保角色頁面的數值更新與儲存功能能夠正常運作，防止往後的修改破壞基本功能。

## 測試覆蓋範圍

### 1. 角色基本信息保存 (`save-logic.test.ts`)
- ✅ 角色名稱、職業、等級的驗證和保存
- ✅ 輸入值的邊界檢查
- ✅ 空值和無效值的處理

### 2. 能力值管理
- ✅ 六項基本能力值 (力量、敏捷、體質、智力、感知、魅力)
- ✅ 數值範圍驗證 (1-30)
- ✅ 整數類型檢查

### 3. 技能熟練度系統
- ✅ 技能名稱驗證
- ✅ 熟練度等級檢查 (0=無熟練, 1=熟練, 2=專精)
- ✅ 保存邏輯正確性

### 4. 貨幣和經驗值
- ✅ 非負整數驗證
- ✅ 零值處理
- ✅ 保存機制測試

### 5. 冒險紀錄管理
- ✅ 自定義記錄的增刪改
- ✅ 必要欄位驗證 (id, name, value)
- ✅ 數據完整性檢查

### 6. 額外數據處理
- ✅ 修整期 (downtime) 驗證
- ✅ 名聲 (renown) 數據結構
- ✅ 威望 (prestige) 信息
- ✅ 空數據處理

### 7. 資料庫操作
- ✅ updateExtraData 參數驗證
- ✅ characterId UUID 格式檢查
- ✅ 錯誤處理機制

### 8. 組件渲染測試 (`CharacterSheet.test.tsx`)
- ✅ 組件正確渲染
- ✅ Props 正確傳遞
- ✅ 基本數據顯示

## 運行測試

### 基本命令

```bash
# 運行所有測試
npm t

# 運行單次測試（不進入 watch 模式）
npm test -- --run

# 運行特定測試文件
npm test -- --run src/test/save-logic.test.ts

# 以詳細模式運行
npm test -- --run --verbose
```

### 測試保護檢查

運行測試保護腳本來驗證測試能夠檢測破壞性變更：

```bash
./test-protection.sh
```

此腳本會：
1. 運行基線測試確保正常
2. 模擬破壞關鍵功能
3. 驗證測試能夠檢測到問題
4. 還原所有修改

## 測試結構

```
src/test/
├── setup.ts                    # 測試環境設置和 Mock
├── CharacterSheet.test.tsx     # 組件渲染測試
├── character-data-services.test.ts # 服務層測試
├── save-logic.test.ts          # 保存邏輯純函數測試  
└── updateExtraData.test.ts     # 額外數據更新測試
```

## Mock 設置

測試使用以下 Mock：
- `@testing-library/jest-dom` - DOM 測試工具
- Supabase 客戶端 Mock
- 所有服務模塊 Mock
- React hooks Mock

## 持續改進

### 添加新功能時
1. 為新的保存邏輯編寫對應測試
2. 確保輸入驗證覆蓋
3. 測試錯誤處理情況
4. 運行完整測試套件

### 修改現有功能時
1. 運行相關測試確保不破壞功能
2. 根據需要更新測試
3. 驗證邊界案例仍然有效

## 最佳實踐

1. **專注於邏輯測試**: 測試業務邏輯而非 UI 細節
2. **輸入驗證**: 確保所有用戶輸入都被正確驗證
3. **錯誤處理**: 測試失敗情況和異常處理
4. **數據完整性**: 驗證保存的數據符合預期格式
5. **邊界測試**: 測試極值和邊界條件

## 疑難排解

### 測試失敗
1. 檢查錯誤訊息中的具體失敗點
2. 確認 Mock 設置正確
3. 驗證測試數據格式
4. 運行單一測試文件進行調試

### 新增測試
1. 參考現有測試結構
2. 使用 describe/it 組織測試
3. 在 beforeEach 中清理 Mock 狀態
4. 為成功和失敗情況都編寫測試

## 技術細節

- **測試框架**: Vitest
- **測試工具**: @testing-library/react
- **Mock 框架**: Vitest 內建 Mock
- **覆蓋目標**: 角色數據的 CRUD 操作
- **驗證重點**: 數據驗證、保存邏輯、錯誤處理

這個測試套件確保了角色管理系統的核心功能穩定性，為後續開發提供了安全保障。